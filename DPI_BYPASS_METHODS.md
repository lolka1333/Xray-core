# Методы обхода DPI в Xray-core

## ОБНОВЛЕНИЕ: Новые методы против блокировки по лимиту данных (декабрь 2024)

### Проблема
РКН начал блокировать соединения с ограничением 15-20KB данных на одно TCP соединение для "подозрительных" IP адресов (зарубежные датацентры, VPS провайдеры).

### Решение: TCP Мультиплексирование
- **Файл**: `transport/internet/tcp/multiplex.go`
- **Автоматическая ротация соединений** при достижении 14KB (безопасный порог)
- **Параллельные соединения** - до 16 одновременных TCP соединений
- **Адаптивное определение лимита** провайдера
- **Маскировка под SSH** - опциональная имитация SSH handshake
- **Умное переиспользование** существующих соединений

## Внедренные методы обхода российских DPI

### 1. TCP Фрагментация пакетов
- **Файл**: `transport/internet/tcp/fragment.go`
- **Описание**: Разбивает TCP пакеты на мелкие фрагменты (по умолчанию 40 байт)
- **Особенности**:
  - Специальная обработка TLS ClientHello
  - Разделение первых 5 байт TLS заголовка
  - Фрагментация области SNI на части по 3 байта
  - Случайные микро-задержки между фрагментами (1-10 мкс)

### 2. TLS Обфускация
- **Файлы**: 
  - `transport/internet/tls/obfuscate.go`
  - `transport/internet/tcp/dialer.go` (TLSObfuscatedConn)
- **Методы**:
  - Добавление случайных TLS расширений
  - Padding extension (RFC 7685) с размером 100-300 байт
  - Перемешивание порядка расширений (кроме SNI)
  - Маскировка SNI через zero-width Unicode символы
  - Фрагментация ClientHello с особым вниманием к области SNI

### 3. HTTP Обфускация
- **Файл**: `transport/internet/http_obfuscate.go`
- **Методы**:
  - Рандомизация регистра HTTP методов и заголовков
  - Добавление случайных пробелов между элементами
  - Двойные слеши в URL путях
  - Добавление фрагментов и случайных параметров к URL
  - Ложные заголовки (X-Forwarded-For, X-Real-IP и др.)
  - Фрагментация HTTP заголовков на части по 20-50 байт
  - FQDN с точкой в конце для Host заголовка

### 4. Системные оптимизации сокетов
- **Файл**: `transport/internet/dpi_bypass.go`
- **TCP опции**:
  - TCP_NODELAY - отключение алгоритма Nagle
  - TCP_QUICKACK - быстрое подтверждение пакетов
  - TCP_USER_TIMEOUT - 30 секунд для неподтвержденных данных
  - TCP_FASTOPEN - ускоренное открытие соединения
  - MSS = 1360 - уменьшенный размер сегмента
  - Window Size = 65535

### 5. TTL Манипуляции
- **Файл**: `transport/internet/dpi_bypass.go`
- **Техника**: 
  - Отправка первых байтов с TTL=3 (не дойдут до сервера)
  - DPI видит "неправильные" данные
  - Восстановление нормального TTL=64 для реальных данных

### 6. WebSocket улучшения
- **Файл**: `transport/internet/websocket/dialer.go`
- **Применение**: HTTP обфускация для WebSocket handshake



## Активация методов

Все методы обхода DPI **активированы по умолчанию** для обычных пользователей и работают автоматически без необходимости изменения конфигурации.

### Автоматическое управление:
- **Включено по умолчанию** для обычного использования
- **Автоматически отключается** в CI/CD окружениях (GitHub Actions, Jenkins)
- **Настраивается** через переменные окружения

### Управление через переменные окружения:
- `XRAY_DPI_BYPASS_DISABLED=true` - полностью отключить обход DPI
- `CI=true` или `GITHUB_ACTIONS=true` - автоматическое отключение для CI/CD

### Проверка состояния:
1. **shouldApplyFragmentation()** - возвращает `true` (если не в CI)
2. **shouldObfuscateTLS()** - возвращает `true` (если не в CI)
3. **shouldApplyHTTPObfuscation()** - возвращает `true` (если не в CI)

## Параметры по умолчанию

### TCP Мультиплексирование (НОВОЕ)
- **Лимит данных на соединение**: 14KB (безопасный порог для РКН)
- **Максимум параллельных соединений**: 16
- **Автоматическая ротация**: при 95% от лимита
- **Таймаут неактивных соединений**: 60 секунд

### Фрагментация и обфускация
- **Размер фрагмента**: 40 байт
- **Задержка между фрагментами**: 50-200 микросекунд
- **TTL для фейковых пакетов**: 3
- **TTL для реальных пакетов**: 64
- **MSS**: 1360 байт
- **TCP Window Size**: 65535
- **Padding размер**: 100-300 байт случайно

## Особенности для российских DPI

Методы специально оптимизированы для обхода российских систем DPI:

1. **Малый размер фрагментов** (40 байт) - эффективен против ТСПУ
2. **Фрагментация SNI** - разбивка на части по 3-5 байт
3. **TTL=3** для первых пакетов - классический метод обхода
4. **Микро-задержки** - нарушают временные паттерны анализа
5. **Рандомизация регистра** - обход простых сигнатур

## Компиляция

```bash
cd /workspace
go build ./...
```

## Примечания

- Все методы работают прозрачно и не требуют изменений в конфигурации
- Методы применяются автоматически ко всем исходящим соединениям
- Совместимы со всеми транспортными протоколами Xray (TCP, WebSocket, gRPC и др.)
- Не влияют на входящие соединения

## Тестирование

Для проверки работы обхода DPI:

1. Запустите Xray с любой стандартной конфигурацией
2. Подключитесь к заблокированным ресурсам
3. Методы обхода применятся автоматически

## Возможные улучшения

При необходимости можно добавить:
- Настройку параметров через конфигурационный файл
- Выборочное применение методов
- Дополнительные техники (например, ESNI)
- Адаптивную подстройку параметров