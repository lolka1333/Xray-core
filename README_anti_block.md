# Конфигурации Xray-core для обхода новых блокировок РКН

## Описание проблемы

РКН ввел новые методы блокировки, особенно активные в мобильных сетях:

1. **Блокировка по размеру данных**: Если в рамках одного TCP-соединения размер данных от сервера к клиенту превышает ~15-20 КБ, соединение "замораживается"
2. **Анализ трафика**: Блокировка работает для HTTPS/TLS 1.3 соединений с подозрительными IP-адресами (зарубежные дата-центры)
3. **Не зависит от содержимого**: Неважно, легитимный ли это HTTPS-трафик или имитация

## Решение

Создано 3 оптимизированных конфигурации:

### 1. server_anti_block.json - Серверная конфигурация
**Ключевые особенности:**
- **XHTTP транспорт** в режиме `packet-up` для фрагментации данных
- **Reality** с Microsoft.com в качестве маскировки
- **Ограничение размера пакетов**: `scMaxEachPostBytes` от 1MB до 16MB
- **Буферизация**: до 64 постов с интервалами 30-200мс
- **TCP оптимизации**: BBR congestion control, MPTCP, TCP Fast Open

### 2. client_anti_block.json - Клиентская конфигурация (стационарная)
**Ключевые особенности:**
- **Mixed протокол** - автоматическое определение SOCKS/HTTP
- **XHTTP в режиме auto** с автоматическим переключением режимов
- **TLS Hello фрагментация** для обхода DPI
- **Умная маршрутизация**: российский трафик напрямую, остальной через VPN
- **Блокировка рекламы** встроенная

### 3. client_mobile_optimized.json - Мобильная оптимизация
**Ключевые особенности:**
- **Меньшие размеры пакетов**: 8-16KB вместо 1-16MB
- **Меньше соединений**: 4-8 вместо 16-32
- **Мобильный User-Agent**: Android Chrome
- **Оптимизированные таймауты** для мобильных сетей
- **Энергосбережение**: меньше keep-alive периодов

## Технические детали обхода

### XHTTP фрагментация
```json
"xhttpSettings": {
  "mode": "packet-up",
  "scMaxEachPostBytes": {
    "from": 8192,
    "to": 16384
  }
}
```

### TLS Hello фрагментация
```json
"fragment": {
  "packets": "tlshello",
  "length": "100-200",
  "interval": "10-20"
}
```

### Reality маскировка
- **Цель**: Microsoft.com (надежный, всегда доступный)
- **Spider параметры**: имитация реального браузинга
- **ML-DSA-65**: дополнительная криптографическая защита

## Установка и использование

1. **Сервер**: Используйте `server_anti_block.json`
2. **Стационарные клиенты**: `client_anti_block.json`
3. **Мобильные клиенты**: `client_mobile_optimized.json`

### Важные настройки:

1. **Замените IP-адрес** в клиентских конфигурациях на реальный IP сервера
2. **Обновите ключи** - используйте свои приватные/публичные ключи
3. **Выберите подходящий домен** для Reality (Microsoft.com уже настроен)

## Принцип работы против блокировок

1. **Фрагментация**: Большие данные разбиваются на множество мелких TCP-соединений
2. **Имитация браузера**: Reality делает трафик неотличимым от посещения Microsoft.com
3. **Переменные размеры**: Случайные размеры пакетов и интервалы между ними
4. **Множественные соединения**: XHTTP использует несколько параллельных соединений

## Производительность

- **Скорость**: Может быть ниже из-за фрагментации, но стабильная работа
- **Мобильные сети**: Оптимизировано для экономии трафика и батареи
- **Задержка**: Минимальная благодаря BBR и оптимизации TCP

## Мониторинг

Для проверки эффективности используйте инструменты:
- Проверка блокировок: RU::TCP 16-20 test
- Мониторинг соединений: `ss -tuln`
- Логи Xray: установите `loglevel: "info"` для отладки