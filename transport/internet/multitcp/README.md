# MultiTCP Transport для X-ray Core

## Описание

MultiTCP - это специализированный транспорт для X-ray Core, разработанный для обхода блокировок российского цензора (РКН). Транспорт решает проблему с новым методом блокировки, введенным в России в 2024-2025 годах.

## Проблема

Российский цензор блокирует TCP соединения с TLS 1.3 к зарубежным серверам при следующих условиях:
- Соединение использует HTTPS и TLS 1.3 (включая VLESS/Reality)
- IP адрес сервера находится за пределами России (датацентры типа Hetzner, Digital Ocean)
- Размер данных от сервера к клиенту превышает ~15-20KB в рамках одного TCP соединения

При превышении лимита соединение "замораживается" - пакеты от сервера перестают доходить до клиента.

## Решение

MultiTCP решает эту проблему следующим образом:

1. **Фрагментация данных**: Автоматически разбивает данные на фрагменты ~15KB
2. **Множественные соединения**: Использует несколько TCP соединений для передачи данных
3. **Совместимость с TLS/Reality**: Полная поддержка существующих протоколов безопасности
4. **Автоматическое управление**: Управляет пулом соединений и их жизненным циклом

## Конфигурация

### Базовая конфигурация

```json
{
  "transport": "multitcp",
  "transportSettings": {
    "max_data_per_conn": 15360,
    "max_connections": 10,
    "conn_timeout": 30,
    "enable_pooling": true,
    "cleanup_interval": 60
  }
}
```

### Расширенная конфигурация

```json
{
  "transport": "multitcp",
  "transportSettings": {
    "max_data_per_conn": 15360,
    "max_connections": 20,
    "conn_timeout": 45,
    "enable_pooling": true,
    "cleanup_interval": 120,
    "adaptive_size": true,
    "min_data_size": 8192,
    "max_data_size": 20480
  }
}
```

### Параметры конфигурации

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|-------------|-----------|
| `max_data_per_conn` | uint32 | 15360 | Максимальный размер данных на одно соединение (байты) |
| `max_connections` | uint32 | 10 | Максимальное количество одновременных соединений |
| `conn_timeout` | uint32 | 30 | Время жизни соединения (секунды) |
| `enable_pooling` | bool | true | Включить пул соединений |
| `cleanup_interval` | uint32 | 60 | Интервал очистки устаревших соединений (секунды) |
| `adaptive_size` | bool | false | Включить адаптивное изменение размера |
| `min_data_size` | uint32 | 1024 | Минимальный размер данных для адаптивного алгоритма |
| `max_data_size` | uint32 | 20480 | Максимальный размер данных для адаптивного алгоритма |

## Пример использования с VLESS+Reality

```json
{
  "outbounds": [
    {
      "protocol": "vless",
      "settings": {
        "vnext": [
          {
            "address": "your-server.example.com",
            "port": 443,
            "users": [
              {
                "id": "your-uuid",
                "encryption": "none",
                "flow": "xtls-rprx-vision"
              }
            ]
          }
        ]
      },
      "streamSettings": {
        "network": "multitcp",
        "transportSettings": {
          "max_data_per_conn": 15360,
          "max_connections": 15,
          "enable_pooling": true
        },
        "security": "reality",
        "realitySettings": {
          "serverName": "example.com",
          "fingerprint": "chrome",
          "shortId": "your-short-id",
          "publicKey": "your-public-key"
        }
      }
    }
  ]
}
```

## Рекомендации

### Для пользователей в России

1. **Размер данных**: Используйте `max_data_per_conn` в диапазоне 14-16KB
2. **Количество соединений**: Начните с 10-15 соединений
3. **Провайдер**: Настройки могут отличаться для разных провайдеров
4. **Мониторинг**: Включите логирование для отслеживания создания соединений

### Оптимизация производительности

- Увеличьте `max_connections` для больших файлов
- Используйте `adaptive_size=true` для автоматической оптимизации
- Настройте `cleanup_interval` в зависимости от нагрузки

### Безопасность

- Всегда используйте с TLS или Reality
- Не используйте слишком много соединений (подозрительно)
- Регулярно обновляйте конфигурацию

## Совместимость

- **X-ray Core**: 1.8.0+
- **Протоколы**: VLESS, VMess, Trojan, Shadowsocks
- **Безопасность**: TLS, Reality, XTLS
- **Платформы**: Linux, Windows, macOS

## Устранение неполадок

### Высокая задержка

- Уменьшите `max_connections`
- Увеличьте `max_data_per_conn` (если позволяет цензор)
- Проверьте настройки сети

### Блокировка соединений

- Уменьшите `max_data_per_conn` до 12-14KB
- Увеличьте `conn_timeout`
- Проверьте логи на наличие ошибок

### Высокое потребление ресурсов

- Уменьшите `max_connections`
- Увеличьте `cleanup_interval`
- Отключите `adaptive_size`

## Логирование

Для диагностики включите информационные логи:

```json
{
  "log": {
    "loglevel": "info"
  }
}
```

MultiTCP выводит информацию о:
- Создании новых соединений
- Балансировке нагрузки
- Очистке устаревших соединений

## Поддержка

При возникновении проблем:

1. Проверьте логи X-ray Core
2. Убедитесь в корректности конфигурации
3. Протестируйте с базовыми настройками
4. Обратитесь в сообщество X-ray/XTLS

## Предупреждения

- Этот транспорт создан специально для российских условий
- Не рекомендуется использовать без необходимости
- Может снизить производительность из-за множественных соединений
- Требует больше ресурсов чем обычный TCP